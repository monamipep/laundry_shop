<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard | Laundry Shop</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f4f6f9; margin:0; padding:0; }
    header { background:#2c3e50; color:#fff; padding:15px 30px; display:flex; justify-content:space-between; align-items:center; }
    h1 { margin:0; font-size:22px; }
    a.logout { background:#e74c3c; color:#fff; padding:6px 12px; text-decoration:none; border-radius:4px; }
    a.logout:hover{ background:#c0392b; }
    .container{ padding:20px; max-width:1200px; margin:0 auto; }

    /* Summary Cards */
    .summary { display:flex; gap:20px; margin-bottom:25px; flex-wrap:wrap; }
    .card { background:#fff; padding:15px; border-radius:8px; flex:1 1 200px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center; min-width:200px; cursor:default; }
    .card.clickable { cursor:pointer; }
    .card h2 { margin:0; color:#3498db; }
    .card p { margin:6px 0 0 0; color:#333; }

    /* Sections & Tables */
    .section { background:#fff; padding:20px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:10px; border:1px solid #ddd; text-align:center; font-size:14px; vertical-align:middle; }
    th { background:#3498db; color:#fff; }
    td { background:#fff; }

    /* Buttons */
    .btn { background:#27ae60; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; transition:0.15s; }
    .btn:hover{ transform:translateY(-1px); }
    .btn-accept { background:#2980b9; }
    .btn-delete { background:#e74c3c; }
    .btn-small { padding:4px 8px; font-size:13px; }

    select, input[type=text], input[type=number] { padding:5px; border-radius:4px; border:1px solid #ccc; }

    /* Status Tags */
    .status { padding:4px 8px; border-radius:6px; color:#fff; font-weight:bold; font-size:13px; display:inline-block; min-width:68px; }
    .Pending { background:#f39c12; }
    .Washing { background:#3498db; }
    .Drying { background:#9b59b6; }
    .Ready { background:#2ecc71; }
    .Claimed { background:#16a085; }

    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal { background:#fff; border-radius:10px; padding:20px; width:90%; max-width:560px; box-shadow:0 8px 30px rgba(0,0,0,0.2); }
    .modal h3 { margin:0 0 10px 0; color:#333; }
    .modal .modal-body { max-height:60vh; overflow:auto; margin-top:8px; }

    /* Responsive */
    @media (max-width:768px) {
      table{ font-size:12px; }
      .summary { flex-direction:column; }
    }
  </style>
</head>
<body>
<header>
  <h1>Admin Dashboard</h1>
  <a href="/logout" class="logout">Logout</a>
</header>

<div class="container">

  <!-- Summary Cards -->
  <div class="summary">
    <div class="card">
      <h2 id="card-total-orders">{{ total_orders or 0 }}</h2>
      <p>Total Orders</p>
    </div>

    <!-- This is clickable to open monthly income modal -->
    <div class="card clickable" id="card-income" title="Click to view monthly income breakdown">
      <h2>₱<span id="card-total-income">{{ "{:,.2f}".format(total_income if total_income else 0) }}</span></h2>
      <p>Total Income (click to view by month)</p>
    </div>

    <div class="card">
      <h2 id="card-total-users">{{ users|length or 0 }}</h2>
      <p>Total Customers</p>
    </div>
  </div>

  <!-- Pending Orders -->
  <div class="section" id="pending-section">
    <h3>Pending Orders per User</h3>

    <!-- We'll rely on template to render user blocks, but JS will update DOM dynamically after actions -->
    {% for u in users %}
      <div class="user-block" data-username="{{ u.username | e }}">
        <h4 style="margin-bottom:6px;">{{ u.username }}</h4>

        {% set pending_orders = u.laundry_orders | selectattr('status', 'equalto', 'Pending') | list %}
        <div class="pending-area">
          {% if pending_orders %}
            <table class="pending-table">
              <thead>
                <tr>
                  <th>ID</th><th>Type</th><th>Weight (kg)</th><th>Price</th><th>Pickup</th><th>Location</th><th>Status</th><th>Date</th><th>Actions</th>
                </tr>
              </thead>
              <tbody>
              {% for o in pending_orders %}
                <tr data-order-id="{{ o.id }}" data-username="{{ u.username | e }}">
                  <td class="col-id">{{ o.id }}</td>
                  <td>{{ o.laundry_type }}</td>
                  <td>{{ o.weight_kg or 0 }}</td>
                  <td>₱{{ "{:,.2f}".format(o.price if o.price else 0) }}</td>
                  <td>{{ 'Yes' if o.pickup_requested else 'No' }}</td>
                  <td>
                    {% if o.pickup_requested %}
                      Floor {{ o.floor_number or '-' }}, Unit {{ o.unit_number or '-' }}
                    {% else %}—{% endif %}
                  </td>
                  <td><span class="status {{ o.status }}">{{ o.status }}</span></td>
                  <td>{{ o.date_created.strftime('%Y-%m-%d %H:%M') if o.date_created else 'N/A' }}</td>
                  <td>
                    <!-- Accept button triggers AJAX status update to Washing. -->
                    <button class="btn btn-accept btn-small accept-btn" data-id="{{ o.id }}" data-new-status="Washing">Accept</button>
                    <button class="btn btn-delete btn-small delete-btn" data-id="{{ o.id }}">Delete</button>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="no-pending" style="margin-left:20px;color:#555;">No pending orders.</p>
          {% endif %}
        </div>
      </div>
      <hr style="margin:16px 0;">
    {% endfor %}
  </div>

  <!-- All Orders -->
  <div class="section" id="all-orders-section">
    <h3>All Orders</h3>
    <table id="all-orders-table">
      <thead>
        <tr>
          <th>ID</th><th>Customer</th><th>Type</th><th>Weight</th><th>Price</th><th>Pickup</th><th>Location</th><th>Status</th><th>Date Created</th><th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for o in orders %}
        <tr data-order-id="{{ o.id }}">
          <td>{{ o.id }}</td>
          <td>{{ o.user.username if o.user else 'Unknown' }}</td>
          <td>{{ o.laundry_type or 'N/A' }}</td>
          <td>{{ o.weight_kg or 0 }} kg</td>
          <td>₱{{ "{:,.2f}".format(o.price if o.price else 0) }}</td>
          <td>{{ 'Yes' if o.pickup_requested else 'No' }}</td>
          <td>
            {% if o.pickup_requested %}
              Floor {{ o.floor_number or '-' }}, Unit {{ o.unit_number or '-' }}
            {% else %}—{% endif %}
          </td>
          <td><span class="status {{ o.status }}">{{ o.status }}</span></td>
          <td>{{ o.date_created.strftime('%Y-%m-%d %H:%M') if o.date_created else 'N/A' }}</td>
          <td>
            <form class="status-form" data-id="{{ o.id }}" style="display:inline;">
              <select name="status" class="status-select">
                <option value="Pending" {% if o.status == 'Pending' %}selected{% endif %}>Pending</option>
                <option value="Washing" {% if o.status == 'Washing' %}selected{% endif %}>Washing</option>
                <option value="Drying" {% if o.status == 'Drying' %}selected{% endif %}>Drying</option>
                <option value="Ready" {% if o.status == 'Ready' %}selected{% endif %}>Ready</option>
                <option value="Claimed" {% if o.status == 'Claimed' %}selected{% endif %}>Claimed</option>
              </select>
              <button class="btn btn-small update-btn" type="submit">Update</button>
            </form>
            <button class="btn btn-delete btn-small delete-btn" data-id="{{ o.id }}">Delete</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Income Modal -->
<div id="income-modal-backdrop" style="display:none;">
  <div class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Income by Month</h3>
      <div class="modal-body" id="income-modal-body">
        <!-- Filled by JS -->
        <p>Loading...</p>
      </div>
      <div style="margin-top:12px; text-align:right;">
        <button class="btn" id="income-close-btn">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
/*
  Frontend behavior notes:
  - Uses Fetch API to call backend endpoints that return JSON.
  - Expects these endpoints (implement them in Flask):
    POST  /api/update_status/<id>    body JSON { status: "Washing" }  -> returns { success: true, order: {...} }
    DELETE /api/delete_order/<id>    -> returns { success: true }
    GET    /api/income_by_month      -> returns { success: true, months: [ { month: "YYYY-MM", total: 1234.5 }, ... ] }
*/

function qs(selector, root=document) { return root.querySelector(selector); }
function qsa(selector, root=document) { return Array.from(root.querySelectorAll(selector)); }

/* Utility to show temporary toast-like message */
function toast(msg, time=2000) {
  const el = document.createElement('div');
  el.textContent = msg;
  Object.assign(el.style, { position:'fixed', right:'20px', bottom:'20px', background:'#333', color:'#fff', padding:'10px 14px', borderRadius:'8px', zIndex:99999, opacity:0, transition:'0.2s' });
  document.body.appendChild(el);
  requestAnimationFrame(()=> el.style.opacity = 1);
  setTimeout(()=> { el.style.opacity = 0; setTimeout(()=> el.remove(), 220); }, time);
}

/* Update the UI for a single order row when status changes (All Orders table) */
function updateAllOrdersRow(order) {
  const tr = document.querySelector(`#all-orders-table tr[data-order-id="${order.id}"]`);
  if (!tr) return;
  // update status label
  const statusSpan = tr.querySelector('.status');
  statusSpan.textContent = order.status;
  // update class names to reflect new status
  statusSpan.className = 'status ' + order.status;
  // update price, date if provided
  const tds = tr.querySelectorAll('td');
  // assume column mapping: 0:id,1:customer,2:type,3:weight,4:price,5:pickup,6:location,7:status,8:date
  if (order.price !== undefined) tds[4].textContent = '₱' + Number(order.price).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  if (order.date_created) tds[8].textContent = order.date_created;
}

/* Remove a pending row (from pending section) after acceptance/delete */
function removePendingRow(orderId) {
  const row = document.querySelector(`.pending-table tr[data-order-id="${orderId}"]`);
  if (row) {
    const tbody = row.parentElement;
    row.remove();
    // if tbody now empty, replace with "No pending orders."
    const table = tbody.closest('table');
    if (tbody.children.length === 0) {
      const pendingArea = table.closest('.pending-area');
      pendingArea.innerHTML = '<p class="no-pending" style="margin-left:20px;color:#555;">No pending orders.</p>';
    }
  } else {
    // maybe it was the only row but already converted to no-pending; nothing to do
  }
}

/* Handle Accept / Update from Pending area */
document.addEventListener('click', async (e) => {
  // Accept button in pending
  if (e.target.matches('.accept-btn')) {
    const id = e.target.dataset.id;
    const newStatus = e.target.dataset.newStatus || 'Washing';
    // call API
    try {
      const resp = await fetch(`/api/update_status/${id}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ status: newStatus })
      });
      const data = await resp.json();
      if (data && data.success) {
        toast('Order accepted');
        // Remove from pending list UI
        removePendingRow(id);
        // Update or add the row in All Orders table
        if (data.order) {
          // if already in all orders table, update; otherwise insert at top
          let existing = document.querySelector(`#all-orders-table tr[data-order-id="${id}"]`);
          if (existing) {
            updateAllOrdersRow(data.order);
          } else {
            insertOrderIntoAllOrders(data.order);
          }
        }
        // update total orders count
        refreshTotals();
      } else {
        toast('Failed to accept order');
        console.error('update failed', data);
      }
    } catch (err) {
      toast('Server error');
      console.error(err);
    }
  }

  // Delete button (works both in pending and all orders)
  if (e.target.matches('.delete-btn')) {
    const id = e.target.dataset.id;
    // show confirmation
    const ok = confirm('Are you sure you want to delete order #' + id + '?');
    if (!ok) return;
    try {
      const resp = await fetch(`/api/delete_order/${id}`, { method: 'DELETE' });
      const data = await resp.json();
      if (data && data.success) {
        // remove from both pending area and all orders table
        removePendingRow(id);
        const tr = document.querySelector(`#all-orders-table tr[data-order-id="${id}"]`);
        if (tr) tr.remove();
        toast('Order deleted');
        refreshTotals();
      } else {
        toast('Delete failed');
      }
    } catch (err) {
      toast('Server error');
      console.error(err);
    }
  }
});

/* Handle Update in All Orders table (status dropdown) */
document.addEventListener('submit', async (e) => {
  if (e.target.matches('.status-form')) {
    e.preventDefault();
    const id = e.target.dataset.id;
    const select = e.target.querySelector('.status-select');
    const newStatus = select.value;
    try {
      const resp = await fetch(`/api/update_status/${id}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ status: newStatus })
      });
      const data = await resp.json();
      if (data && data.success) {
        toast('Status updated');
        if (data.order) updateAllOrdersRow(data.order);
        // If status changed to not Pending and it existed in a pending table, remove it
        if (newStatus !== 'Pending') removePendingRow(id);
      } else {
        toast('Update failed');
      }
    } catch (err) {
      toast('Server error');
      console.error(err);
    }
  }
});

/* Helper to insert an order row into All Orders table when Accepting from Pending creates a new row */
function insertOrderIntoAllOrders(order) {
  const tbody = qs('#all-orders-table tbody');
  if (!tbody) return;
  // build a row consistent with template columns
  const tr = document.createElement('tr');
  tr.dataset.orderId = order.id;
  tr.innerHTML = `
    <td>${order.id}</td>
    <td>${order.customer || 'Unknown'}</td>
    <td>${order.type || 'N/A'}</td>
    <td>${order.weight || 0} kg</td>
    <td>₱${Number(order.price || 0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</td>
    <td>${order.pickup ? 'Yes' : 'No'}</td>
    <td>${order.location || '—'}</td>
    <td><span class="status ${order.status}">${order.status}</span></td>
    <td>${order.date_created || 'N/A'}</td>
    <td>
      <form class="status-form" data-id="${order.id}" style="display:inline;">
        <select name="status" class="status-select">
          <option value="Pending"${order.status==='Pending'?' selected':''}>Pending</option>
          <option value="Washing"${order.status==='Washing'?' selected':''}>Washing</option>
          <option value="Drying"${order.status==='Drying'?' selected':''}>Drying</option>
          <option value="Ready"${order.status==='Ready'?' selected':''}>Ready</option>
          <option value="Claimed"${order.status==='Claimed'?' selected':''}>Claimed</option>
        </select>
        <button class="btn btn-small update-btn" type="submit">Update</button>
      </form>
      <button class="btn btn-delete btn-small delete-btn" data-id="${order.id}">Delete</button>
    </td>
  `;
  // insert at top
  tbody.prepend(tr);
}

/* Refresh totals on page (counts & income). If you want to recalc server-side, call another endpoint. For now we will update totals optimistically. */
function refreshTotals() {
  // total orders: simply count rows in all-orders table
  const totalOrders = document.querySelectorAll('#all-orders-table tbody tr').length;
  qs('#card-total-orders').textContent = totalOrders;

  // total income: sum price column in all orders table
  let totalIncome = 0;
  document.querySelectorAll('#all-orders-table tbody tr').forEach(tr=>{
    const priceTd = tr.children[4];
    if (!priceTd) return;
    const txt = priceTd.textContent.replace(/[^0-9.-]+/g,''); // remove currency/commas
    const val = parseFloat(txt) || 0;
    totalIncome += val;
  });
  qs('#card-total-income').textContent = Number(totalIncome).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
}

/* Income modal behavior */
const incomeModalBackdrop = qs('#income-modal-backdrop');
qs('#card-income').addEventListener('click', async () => {
  // open modal, load data
  incomeModalBackdrop.style.display = 'block';
  const body = qs('#income-modal-body');
  body.innerHTML = '<p>Loading monthly income…</p>';
  try {
    const resp = await fetch('/api/income_by_month');
    const data = await resp.json();
    if (data && data.success && Array.isArray(data.months)) {
      if (data.months.length === 0) {
        body.innerHTML = '<p>No income records found.</p>';
      } else {
        // create a simple table
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.innerHTML = `<thead><tr><th style="background:#3498db;color:#fff;padding:8px;border-radius:4px 0 0 4px;">Month</th>
                           <th style="background:#3498db;color:#fff;padding:8px;">Total</th></tr></thead>`;
        const tbody = document.createElement('tbody');
        data.months.forEach(m=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #eee;">${m.month}</td>
                          <td style="padding:8px;border-bottom:1px solid #eee;">₱${Number(m.total||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        body.innerHTML = '';
        body.appendChild(table);
      }
    } else {
      body.innerHTML = '<p>Failed to load income.</p>';
    }
  } catch (err) {
    body.innerHTML = '<p>Server error while loading income.</p>';
    console.error(err);
  }
});
qs('#income-close-btn').addEventListener('click', ()=> { incomeModalBackdrop.style.display = 'none'; });

/* Initialization after load */
window.addEventListener('DOMContentLoaded', () => {
  // make sure pending-area blocks that had table removed show no-pending text if no rows existed server-side
  document.querySelectorAll('.user-block').forEach(block => {
    const area = block.querySelector('.pending-area');
    if (!area) return;
    const table = area.querySelector('table');
    if (!table) {
      // ensure there's no stale empty element
      if (!area.querySelector('.no-pending')) {
        area.innerHTML = '<p class="no-pending" style="margin-left:20px;color:#555;">No pending orders.</p>';
      }
    } else {
      const tbody = table.querySelector('tbody');
      if (!tbody || tbody.children.length === 0) {
        area.innerHTML = '<p class="no-pending" style="margin-left:20px;color:#555;">No pending orders.</p>';
      }
    }
  });

  // initial totals refresh in case server-side template values are out of sync
  refreshTotals();
});
</script>
</body>
</html>



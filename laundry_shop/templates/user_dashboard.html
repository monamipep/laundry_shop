const paymentModal = document.getElementById('paymentModal');
const modalTotal = document.getElementById('modalTotal');
const modalContent = paymentModal.querySelector('.modal-content');

let currentPayRow = null; // track which order is being paid

// Show Payment Modal for individual order
document.querySelectorAll(".pay-order-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
        currentPayRow = btn.closest("tr");
        const price = parseFloat(currentPayRow.querySelector(".order-price").textContent.replace('₱',''));
        modalTotal.textContent = `Total: ₱${price.toFixed(2)}`;

        // Add GCash QR image dynamically
        const qrExisting = modalContent.querySelector("#gcashQrImg");
        if(!qrExisting){
            const qrImg = document.createElement("img");
            qrImg.src = "{{ url_for('static', filename='img/gcash_qr.png') }}";
            qrImg.id = "gcashQrImg";
            qrImg.style.width = "200px";
            qrImg.style.display = "none";
            qrImg.style.margin = "10px auto";
            qrImg.style.display = "block";
            modalContent.appendChild(qrImg);
        } else {
            qrExisting.style.display = "none";
        }

        paymentModal.classList.add("show");
    });
});

// Pay with Cash
document.getElementById("cashBtn").addEventListener("click", ()=>{
    if(currentPayRow){
        currentPayRow.querySelector(".order-status").textContent = "Paid";
        updateTotalPaid();
        alert("Pay cash upon pickup. Thank you!");
    }
    paymentModal.classList.remove("show");
});

// Pay with GCash
document.getElementById("gcashBtn").addEventListener("click", ()=>{
    const qrImg = document.getElementById("gcashQrImg");
    if(qrImg) qrImg.style.display = "block";
    alert("Scan the QR code to pay. Thank you!");
    if(currentPayRow){
        currentPayRow.querySelector(".order-status").textContent = "Paid";
        updateTotalPaid();
    }
    // optionally close modal after a short delay
    setTimeout(()=>{ paymentModal.classList.remove("show"); }, 2000);
});

// Update total paid
function updateTotalPaid(){
    let totalPaid = 0;
    document.querySelectorAll("#ordersTable .order-status").forEach(statusCell=>{
        if(statusCell.textContent.trim() === "Paid"){
            const priceCell = statusCell.parentElement.querySelector(".order-price");
            totalPaid += parseFloat(priceCell.textContent.replace('₱',''));
        }
    });
    document.getElementById("totalPaid").textContent = `Total Paid: ₱${totalPaid.toFixed(2)}`;
}

window.addEventListener('click', e=>{
    if(e.target==paymentModal) paymentModal.classList.remove('show');
});




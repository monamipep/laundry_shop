<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Dashboard | Laundry Shop</title>
<style>
body {
    font-family: 'Segoe UI', Arial, sans-serif;
    margin: 40px 10px;
    background: url("{{ url_for('static', filename='img/laundry-background.png') }}") no-repeat center center fixed;
    background-size: cover;
}
.container {
    max-width: 900px;
    margin: auto;
    background: rgba(240, 248, 255, 0.96);
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
h2, h3 { color: #004080; margin-top: 0; }
.logout-box {
    display: block;
    margin: 20px auto 0 auto;
    background: #ff9933;
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: bold;
    text-decoration: none;
    text-align:center;
}
.logout-box:hover { background: #ff7700; }
.laundry-types { display:flex; flex-wrap:wrap; gap:15px; margin:15px 0; }
.laundry-option {
    flex:1 1 150px;
    text-align:center;
    border:2px solid #aac8ff;
    border-radius:12px;
    padding:15px;
    cursor:pointer;
    transition:0.3s;
    background:white;
    position: relative;
}
.laundry-option:hover { border-color:#007bff; background:#e8f2ff; }
.laundry-option.selected { border-color:#007bff; background:#d6e7ff; }
.laundry-option img { width:70px; height:70px; margin-bottom:10px; object-fit:contain; }
.laundry-option input { display:none; }
input, button, select { padding:8px; margin:5px 0; width:100%; box-sizing:border-box; border:1px solid #aac8ff; border-radius:5px; }
button {
    background:#007bff;
    border:none;
    color:white;
    cursor:pointer;
    font-weight:bold;
    border-radius:6px;
    transition: background 0.3s;
}
button:hover { background:#0056b3; }

/* Toggle Switch */
.switch { position: relative; display: inline-block; width: 60px; height: 34px; margin-right:10px; }
.switch input {display:none;}
.slider {
  position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc; transition: .4s; border-radius:34px;
}
.slider:before {
  position: absolute; content: ""; height: 26px; width: 26px;
  left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius:50%;
}
input:checked + .slider { background-color: #007bff; }
input:checked + .slider:before { transform: translateX(26px); }

.pickup-section { margin-top:15px; padding:15px; background:#f0f8ff; border:1px solid #aac8ff; border-radius:10px; }
#pickupDetails { display:none; margin-top:10px; }

table { width:100%; border-collapse:collapse; margin-top:15px; font-size:14px; background:white; border-radius:8px; overflow:hidden; }
th, td { padding:10px; border:1px solid #cce; text-align:center; }
th { background:#007bff; color:white; }
tr:nth-child(even){ background:#f5faff; }
.total-paid { font-weight:bold; text-align:right; margin-top:10px; color:#004080; }

/* Modal */
.modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.5); }
.modal.show { display:flex; justify-content:center; align-items:center; }
.modal-content { background:white; padding:20px; border-radius:10px; width:90%; max-width:400px; max-height:80vh; overflow-y:auto; position:relative; text-align:center; }
.close { position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px; }

/* Centered Delivery Modal */
#deliveryPopup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transition: opacity 0.2s ease, visibility 0.2s ease;
  z-index: 9999;
}
#deliveryPopup.show {
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
}
#deliveryPopup .modal-content {
  background: white;
  padding: 20px;
  border-radius: 12px;
  width: 280px;
  text-align: center;
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
}
</style>
</head>
<body>

<div class="container">
<h2>Welcome, {{ user.username }} ðŸ‘‹</h2>

<h3>Place a New Laundry Order</h3>
<form method="POST" id="orderForm">
<label><b>Select Laundry Type:</b></label>
<div class="laundry-types">
  <label class="laundry-option">
    <input type="radio" name="laundry_type" value="Wash-Dry-Fold" data-price="250" required>
    <img src="{{ url_for('static', filename='img/wash.png') }}">
    <div>Wash-Dry-Fold<br><small>â‚±250/kg</small></div>
  </label>
  <label class="laundry-option">
    <input type="radio" name="laundry_type" value="Wash-Dry-Press" data-price="300">
    <img src="{{ url_for('static', filename='img/press.png') }}">
    <div>Wash-Dry-Press<br><small>â‚±300/kg</small></div>
  </label>
  <label class="laundry-option">
    <input type="radio" name="laundry_type" value="Press Only" data-price="100">
    <img src="{{ url_for('static', filename='img/iron.png') }}">
    <div>Press Only<br><small>â‚±100/kg</small></div>
  </label>
  <label class="laundry-option">
    <input type="radio" name="laundry_type" value="Dry Cleaning" data-price="450">
    <img src="{{ url_for('static', filename='img/special.png') }}">
    <div>Dry Cleaning<br><small>â‚±450</small></div>
  </label>
</div>

<label>Weight (kg):</label>
<input type="number" name="weight" step="0.1" min="0.5" required>
<p id="pricePreview">Total: â‚±0.00</p>

<label><b>Delivery </b></label>
<div class="pickup-section">
  <label class="switch">
    <input type="checkbox" id="pickupCheck">
    <span class="slider"></span>
  </label>
 Delivery (+â‚±70)

  <div id="pickupDetails">
    <label>Floor:
      <select id="floorSelect">
        <option value="">Select Floor</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
      </select>
    </label>
    <label>Room/Unit:
      <select id="roomSelect">
        <option value="">Select Room</option>
      </select>
    </label>
  </div>
</div>

<button type="submit" id="submitOrder">Submit Order</button>
</form>

<h3>My Laundry Orders</h3>
<table id="ordersTable">
  <tr>
    <th>ID</th>
    <th>Type</th>
    <th>Weight</th>
    <th>Price</th>
    <th>Delivery</th>
    <th>Status</th>
    <th>Payment Status</th>
    <th>Date Created</th>
    <th>Action</th>
  </tr>
  {% for o in orders %}
  <tr data-id="{{ o.id }}">
    <td>{{ o.id }}</td>
    <td class="type-cell">{{ o.laundry_type }}</td>
    <td class="weight-cell">{{ o.weight_kg }} kg</td>
    <td class="order-price">â‚±{{ "%.2f"|format(o.price) }}</td>
    <td class="pickup-cell">
      {% if o.pickup_requested %}
        Yes<br><small>Floor {{ o.floor_number }}, Unit {{ o.unit_number }}</small>
      {% else %}
        No
      {% endif %}
    </td>
    <td class="order-status">{{ o.status }}</td>
    <td class="payment-status">
      {% if o.payment_status %}
        {{ o.payment_status }}
      {% else %}
        Pending
      {% endif %}
    </td>
    <td>{{ o.date_created.strftime('%Y-%m-%d %H:%M') }}</td>
    <td class="action-cell">
  <button class="pay-order-btn" data-id="{{ o.id }}">
    {{ 'Pay' if o.payment_status != 'Paid' else 'Paid' }}
  </button>
  <button class="update-order-btn" data-id="{{ o.id }}">Update</button>
</td>
  </tr>
  {% else %}
  <tr><td colspan="9">No orders yet.</td></tr>
  {% endfor %}
</table>


<a href="{{ url_for('logout') }}" class="logout-box">Logout</a>

<!-- Delivery Modal -->
<div id="deliveryPopup" class="modal">
  <div class="modal-content">
    <h3>Order Summary</h3>
    <p id="deliveryMessage"></p>
    <div style="margin-top:15px;">
      <button id="confirmDelivery" type="button">OK</button>
      <button id="cancelDelivery" type="button">Cancel</button>
    </div>
  </div>
</div>
<!-- PAYMENT MODAL -->
<div id="paymentModal" class="modal">
  <div class="modal-content">
    <span id="closePaymentModal" class="close">&times;</span>
    <h3>Choose Payment Method</h3>
    <button id="cashBtn" type="button">Cash</button>
    <button id="gcashBtn" type="button">Gcash</button>
    <div id="gcashQrImg" style="display:none; margin-top:10px;">
      <img src="{{ url_for('static', filename='img/gcash_qr.png') }}" alt="Gcash QR" style="width:150px;">
    </div>
    <p id="gcashText" style="display:none;">Scan QR to pay</p>
    <p id="cashConfirm" style="display:none; color:green; font-weight:bold;">Pay at the counter when you pick up!</p>
  </div>
</div>

<!-- UPDATE MODAL -->
<div id="updateModal" class="modal">
  <div class="modal-content">
    <span id="closeUpdateModal" class="close">&times;</span>
    <h3>Update Order</h3>
    <label><b>Select Laundry Type:</b></label>
    <div id="updateLaundryTypes" class="laundry-types"></div>
    <label>Weight (kg):</label>
    <input type="number" id="updateWeight" step="0.1" min="0.5">
    <p id="updatePricePreview">Total: â‚±0.00</p>
    <label><b>Delivery </b></label>
    <div class="pickup-section">
      <label class="switch">
        <input type="checkbox" id="updatePickupCheck">
        <span class="slider"></span>
      </label>
      Delivery (+â‚±70)
      <div id="updatePickupDetails" style="display:none; margin-top:10px;">
        <label>Floor:
          <select id="updateFloorSelect">
            <option value="">Select Floor</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
          </select>
        </label>
        <label>Room/Unit:
          <select id="updateRoomSelect">
            <option value="">Select Room</option>
          </select>
        </label>
      </div>
    </div>
    <button id="confirmUpdate" type="button" style="margin-top:10px;">Confirm Update</button>
  </div>
</div>

<script>
// ===== LAUNDRY SELECTION =====
const laundryOptions = document.querySelectorAll('.laundry-option');
laundryOptions.forEach(option => {
    const input = option.querySelector('input');
    option.addEventListener('click', () => {
        laundryOptions.forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        input.checked = true;
        updatePrice();
    });
});

// ===== DELIVERY TOGGLE =====
const pickupCheck = document.getElementById('pickupCheck');
const pickupDetails = document.getElementById('pickupDetails');
pickupCheck.addEventListener('change', () => {
    pickupDetails.style.display = pickupCheck.checked ? 'block' : 'none';
    updatePrice();
});

// ===== FLOOR & ROOM =====
const floorSelect = document.getElementById('floorSelect');
const roomSelect = document.getElementById('roomSelect');
floorSelect.addEventListener('change', () => {
    const floor = parseInt(floorSelect.value);
    roomSelect.innerHTML = '<option value="">Select Room</option>';
    if(floor) {
        for(let i=1; i<=5; i++){
            const room = floor*100 + i;
            const opt = document.createElement('option');
            opt.value = room;
            opt.textContent = room;
            roomSelect.appendChild(opt);
        }
    }
});

// ===== PRICE CALCULATION =====
const weightInput = document.querySelector('input[name="weight"]');
const pricePreview = document.getElementById('pricePreview');
function updatePrice(){
    let total=0;
    const laundry = document.querySelector('input[name="laundry_type"]:checked');
    const weight = parseFloat(weightInput.value)||0;
    if(laundry) total += weight*parseFloat(laundry.dataset.price);
    if(pickupCheck.checked) total+=70;
    pricePreview.textContent = `Total: â‚±${total.toFixed(2)}`;
}
weightInput.addEventListener('input', updatePrice);
document.querySelectorAll('input[name="laundry_type"]').forEach(i => i.addEventListener('change', updatePrice));

// ===== DELIVERY POPUP =====
const submitOrder = document.getElementById('submitOrder');
const deliveryPopup = document.getElementById('deliveryPopup');
const deliveryMessage = document.getElementById('deliveryMessage');
const confirmDelivery = document.getElementById('confirmDelivery');
const cancelDelivery = document.getElementById('cancelDelivery');

submitOrder.addEventListener('click', e => {
    e.preventDefault();
    const laundry = document.querySelector('input[name="laundry_type"]:checked');
    if(!laundry) return alert("Please select a laundry type.");
    const weight = parseFloat(weightInput.value)||0;
    if(weight <= 0) return alert("Please enter a valid weight.");

    let total = weight*parseFloat(laundry.dataset.price);
    const pickupRequested = pickupCheck.checked;
    if(pickupRequested) total += 70;

    deliveryMessage.innerHTML = `
        Type: ${laundry.value}<br>
        Weight: ${weight} kg<br>
        Delivery: ${pickupRequested ? 'Yes (+â‚±70)' : 'No'}<br>
        Total: â‚±${total.toFixed(2)}
    `;
    deliveryPopup.classList.add('show');

    // Store data for confirmation
    deliveryPopup.dataset.laundryType = laundry.value;
    deliveryPopup.dataset.weight = weight;
    deliveryPopup.dataset.total = total.toFixed(2);
    deliveryPopup.dataset.pickupRequested = pickupRequested;
    deliveryPopup.dataset.floor = floorSelect.value;
    deliveryPopup.dataset.unit = roomSelect.value;
});

// ===== CONFIRM DELIVERY WITH AJAX =====
confirmDelivery.addEventListener('click', async () => {
    const laundry = document.querySelector('input[name="laundry_type"]:checked');
    if(!laundry) return alert("Please select a laundry type.");

    const weight = parseFloat(weightInput.value) || 0;
    if(weight <= 0) return alert("Please enter a valid weight.");

    const pickupRequested = pickupCheck.checked;
    const floorNumber = pickupRequested ? floorSelect.value : null;
    const unitNumber = pickupRequested ? roomSelect.value : null;

    // Calculate price
    let price = weight * parseFloat(laundry.dataset.price);
    if(pickupRequested) price += 70;

    // Prepare payload
    const payload = {
        laundry_type: laundry.value,
        weight: weight,
        price: price,
        pickup_requested: pickupRequested,
        floor_number: floorNumber,
        unit_number: unitNumber
    };

    try {
        const response = await fetch("/add_order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        if(response.ok){
            // Add new row to table
            const ordersTable = document.getElementById('ordersTable');
            const row = ordersTable.insertRow(-1);
            row.setAttribute('data-id', data.id);
            row.innerHTML = `
                <td>${data.id}</td>
                <td class="type-cell">${data.laundry_type}</td>
                <td class="weight-cell">${data.weight} kg</td>
                <td class="order-price">â‚±${data.price.toFixed(2)}</td>
                <td class="pickup-cell">${data.pickup_requested ? `Yes<br>Floor ${data.floor_number}, Unit ${data.unit_number}` : 'No'}</td>
                <td class="order-status">Pending</td>
                <td class="payment-status">Pending</td>
                <td>${data.date_created}</td>
                <td>
                    <button class="pay-order-btn">Pay</button>
                    <button class="update-order-btn">Update</button>
                </td>
            `;
            attachTableButtons(row); // Attach pay/update events

            // Reset form & hide modal
            document.getElementById('orderForm').reset();
            pickupDetails.style.display = 'none';
            deliveryPopup.classList.remove('show');

            alert("Order submitted successfully!");
        } else {
            alert("Error adding order: " + (data.message || "Unknown error"));
        }

    } catch (err) {
        console.error(err);
        alert("Failed to add order. Please try again.");
    }
});


// ===== PAYMENT & UPDATE MODAL HANDLERS =====
const paymentModal = document.getElementById('paymentModal');
const cashBtn = document.getElementById("cashBtn");
const gcashBtn = document.getElementById("gcashBtn");
const gcashQrImg = document.getElementById("gcashQrImg");
const gcashText = document.getElementById("gcashText");
const cashConfirm = document.getElementById('cashConfirm');

const updateModal = document.getElementById('updateModal');
const closeUpdateModal = document.getElementById('closeUpdateModal');
const updateLaundryTypes = document.getElementById('updateLaundryTypes');
const updateWeight = document.getElementById('updateWeight');
const updatePricePreview = document.getElementById('updatePricePreview');
const confirmUpdate = document.getElementById('confirmUpdate');
const updatePickupCheck = document.getElementById('updatePickupCheck');
const updatePickupDetails = document.getElementById('updatePickupDetails');
const updateFloorSelect = document.getElementById('updateFloorSelect');
const updateRoomSelect = document.getElementById('updateRoomSelect');
let currentUpdateRow = null;

// Clone laundry options for update modal
function cloneLaundryOptions(){
    updateLaundryTypes.innerHTML = '';
    laundryOptions.forEach(option => {
        const clone = option.cloneNode(true);
        clone.classList.remove('selected');
        const cloneInput = clone.querySelector('input');
        cloneInput.checked = false;
        clone.addEventListener('click', () => {
            updateLaundryTypes.querySelectorAll('.laundry-option').forEach(o => o.classList.remove('selected'));
            clone.classList.add('selected');
            cloneInput.checked = true;
            updateUpdatePrice();
        });
        updateLaundryTypes.appendChild(clone);
    });
}

function updateUpdatePrice(){
    let total = 0;
    const weight = parseFloat(updateWeight.value) || 0;
    const selectedLaundryInput = updateLaundryTypes.querySelector('input[name="laundry_type"]:checked');
    if(selectedLaundryInput) total += weight * parseFloat(selectedLaundryInput.dataset.price);
    if(updatePickupCheck.checked) total += 70;
    updatePricePreview.textContent = `Total: â‚±${total.toFixed(2)}`;
}

// Attach pay/update buttons for each row
function attachTableButtons(row){
    row.querySelector('.pay-order-btn').addEventListener('click', () => {
        paymentModal.classList.add('show');

        const isPaid = row.querySelector('.payment-status').textContent.trim() === 'Paid';

        if(isPaid){
            // Already paid: show info instead of payment options
            cashConfirm.style.display = 'block';
            cashConfirm.textContent = 'This order is already paid.';
            gcashQrImg.style.display = 'none';
            gcashText.style.display = 'none';
        } else {
            // Not paid: show normal payment options
            cashConfirm.style.display = 'none';
            gcashQrImg.style.display = 'none';
            gcashText.style.display = 'none';
        }
    });

    row.querySelector('.update-order-btn').addEventListener('click', () => {
        currentUpdateRow = row;
        cloneLaundryOptions();
        const type = row.querySelector('.type-cell').textContent.trim();
        const weight = parseFloat(row.querySelector('.weight-cell').textContent)||0;
        const pickupText = row.querySelector('.pickup-cell').innerHTML;
        updateWeight.value = weight;
        const inputToSelect = updateLaundryTypes.querySelector(`input[value="${type}"]`);
        if(inputToSelect){
            inputToSelect.checked = true;
            inputToSelect.parentElement.classList.add('selected');
        }
        updatePickupCheck.checked = pickupText.includes('Yes');
        updatePickupDetails.style.display = updatePickupCheck.checked?'block':'none';
        updateModal.classList.add('show');
        updateUpdatePrice();
    });
}


// Attach existing rows
document.querySelectorAll('#ordersTable tr').forEach(row => {
    if(row.querySelector('.pay-order-btn')) attachTableButtons(row);
});

// PAYMENT MODAL
cashBtn.addEventListener('click', ()=>{
    cashConfirm.style.display='block';
    gcashQrImg.style.display='none';
    gcashText.style.display='none';
    setTimeout(()=>{ cashConfirm.style.display='none'; },5000);
});
gcashBtn.addEventListener('click', ()=>{
    gcashQrImg.style.display='block';
    gcashText.style.display='block';
    cashConfirm.style.display='none';
});
document.getElementById('closePaymentModal').addEventListener('click', ()=> paymentModal.classList.remove('show'));
window.addEventListener('click', e=>{ if(e.target===paymentModal) paymentModal.classList.remove('show'); });

// UPDATE MODAL
closeUpdateModal.addEventListener('click', ()=> updateModal.classList.remove('show'));
window.addEventListener('click', e=>{ if(e.target===updateModal) updateModal.classList.remove('show'); });

updatePickupCheck.addEventListener('change', ()=> {
    updatePickupDetails.style.display = updatePickupCheck.checked?'block':'none';
    updateUpdatePrice();
});

updateFloorSelect.addEventListener('change', ()=> {
    const floor = parseInt(updateFloorSelect.value);
    updateRoomSelect.innerHTML = '<option value="">Select Room</option>';
    if(floor){
        for(let i=1;i<=5;i++){
            const room = floor*100 + i;
            const opt = document.createElement('option');
            opt.value = room;
            opt.textContent = room;
            updateRoomSelect.appendChild(opt);
        }
    }
});

updateWeight.addEventListener('input', updateUpdatePrice);

// CONFIRM UPDATE
confirmUpdate.addEventListener('click', ()=>{
    const selectedLaundryInput = updateLaundryTypes.querySelector('input[name="laundry_type"]:checked');
    if(!selectedLaundryInput) return alert("Please select a laundry type.");
    const newWeight = parseFloat(updateWeight.value) || 0;
    if(newWeight <= 0) return alert("Please enter valid weight.");
    const newType = selectedLaundryInput.value;
    currentUpdateRow.querySelector('.type-cell').textContent = newType;
    currentUpdateRow.querySelector('.weight-cell').textContent = `${newWeight} kg`;
    currentUpdateRow.querySelector('.order-price').textContent = updatePricePreview.textContent;
    currentUpdateRow.querySelector('.pickup-cell').textContent = updatePickupCheck.checked ?
        `Yes<br>Floor ${updateFloorSelect.value}, Unit ${updateRoomSelect.value}` : 'No';
    updateModal.classList.remove('show');
    alert("Order updated! (changes are client-side)");
});
</script>

</body>
</html>





